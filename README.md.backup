# ğŸŒ Multi-Site Static Hosting with Caddy

![Caddy](https://img.shields.io/badge/Caddy-2.0-00d4aa?style=for-the-badge&logo=caddy)
![Docker](https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=docker&logoColor=white)
![PHP](https://img.shields.io/badge/PHP-777BB4?style=for-the-badge&logo=php&logoColor=white)
![Security](https://img.shields.io/badge/Security-Production_Ready-orange?style=for-the-badge)

## Overview
Deploy hundreds of static sites with automatic HTTPS, monitoring, and production-ready security

[ğŸš€ Quick Start](#-quick-start) â€¢ [ğŸ“– Documentation](#-documentation-links) â€¢ [ğŸ›¡ï¸ Security](#-security) â€¢ [ğŸ“Š Monitoring](#-monitoring)

---

## ğŸ¯ What This Does
This solution deploys **hundreds of static sites** (HTML/JS/CSS/PHP) behind a single Caddy server with:
- ğŸ”’ **Automatic HTTPS** via Let's Encrypt
- ğŸ›¡ï¸ **Production-ready security** with basic hardening
- ğŸ“Š **Built-in monitoring** with Prometheus metrics
- ğŸ³ **Containerized deployment** with Docker Compose
- âš¡ **Zero-configuration** site addition

## âœ¨ Key Features

| ğŸš€ **Feature** | ğŸ¯ **Benefit** | ğŸ’¡ **Description** |
|----------------|----------------|-------------------|
| ğŸ”’ **Auto HTTPS** | Zero-config SSL | Automatic Let's Encrypt certificates |
| ğŸ“ **One-folder sites** | Simple organization | Each domain gets its own folder |
| âš¡ **Zero-config hosting** | No per-site setup | On-demand TLS with automatic approval |
| ğŸ› ï¸ **Simple scripts** | Easy management | Add sites with one command |
| ğŸ³ **Containerized** | Consistent deployment | Docker Compose for all services |
| ğŸ›¡ï¸ **Basic security** | Production ready | Security headers, basic isolation |
| ğŸ“Š **Built-in monitoring** | Full visibility | Prometheus metrics for all services |
| ğŸ’¾ **Backup system** | Data protection | Automated backup scripts |
## ğŸ“‹ Requirements

| ğŸ”§ **Requirement** | âœ… **Status** | ğŸ“ **Description** |
|-------------------|---------------|-------------------|
| ğŸ³ **Docker** | Required | Docker and Docker Compose |
| ğŸŒ **DNS Setup** | Required | A/AAAA records pointing to server IP |
| ğŸ”‘ **Email** | Required | For Let's Encrypt certificate registration |
---

## ğŸš€ Quick Start
### ğŸ¯ **Easy Way (Recommended)**

```bash
./scripts/start.sh
```
**This script automatically:**
- âœ… Copies `.env.example` to `.env` if missing
- âœ… Validates your environment configuration  
- âœ… Checks Caddyfile formatting
- âœ… Starts all services
- âœ… Verifies everything is working

---

### ğŸ”§ **Manual Way**

| ğŸ“‹ **Step** | ğŸ’» **Command** | ğŸ¯ **Purpose** |
|-------------|----------------|----------------|
| 1ï¸âƒ£ **Setup Environment** | `cp .env.example .env` | Create configuration file |
| 2ï¸âƒ£ **Configure Email** | Edit `.env` â†’ `CADDY_EMAIL=your-email@example.com` | Set Let's Encrypt email |
| 3ï¸âƒ£ **Start Services** | `./scripts/start.sh` | Launch all containers (auto-generates secrets) |
| 4ï¸âƒ£ **Add Site** | `./scripts/add-site.sh example.com --www` | Create your first site |
| 5ï¸âƒ£ **Configure DNS** | Point `example.com` to server IP | Enable HTTPS |

**After setup, visit:** `https://example.com` ğŸ‰

## ğŸ“ Project Structure

```text
ğŸŒ multi-site-recovered/
â”œâ”€â”€ ğŸ“„ .env.example              # Environment template (REQUIRED)
â”œâ”€â”€ âš™ï¸  Caddyfile                # Caddy configuration
â”œâ”€â”€ ğŸ³ compose.yml               # Docker services
â”œâ”€â”€ ğŸ“– README.md                 # Main documentation
â”œâ”€â”€ ğŸ›¡ï¸  SECURITY.md              # Security guide
â”œâ”€â”€ ğŸ“Š monitoring/               # Monitoring setup
â”‚   â”œâ”€â”€ ğŸ“– README.md
â”‚   â”œâ”€â”€ âš™ï¸  prometheus-config.txt
â”‚   â”œâ”€â”€ ğŸ”§ php-fpm.conf
â”‚   â””â”€â”€ ğŸ“ˆ grafana-dashboard.json
â”œâ”€â”€ ğŸ› ï¸  scripts/                 # Management scripts
â”‚   â”œâ”€â”€ â• add-site.sh           # Add new sites
â”‚   â”œâ”€â”€ ğŸ’¾ backup.sh             # Create backups
â”‚   â”œâ”€â”€ ğŸŒ cf-set-dns.sh         # Cloudflare DNS setup
â”‚   â”œâ”€â”€ âš¡ fix-udp-buffers.sh    # Performance optimization
â”‚   â”œâ”€â”€ ğŸ”§ format-caddyfile.sh   # Format Caddyfile
â”‚   â”œâ”€â”€ ğŸ” generate-secret.sh    # Generate secure secrets
â”‚   â”œâ”€â”€ ğŸ“Š setup-monitoring-simple.sh # Setup monitoring
â”‚   â”œâ”€â”€ ğŸš€ start.sh              # Start all services
â”‚   â”œâ”€â”€ ğŸ“‹ status.sh             # Check system status
â”‚   â””â”€â”€ âœ… validate.sh           # Validate configuration
â”œâ”€â”€ ğŸ³ ask/                      # Domain approval service
â”‚   â”œâ”€â”€ ğŸ app.py
â”‚   â””â”€â”€ ğŸ³ Dockerfile
â””â”€â”€ ğŸŒ sites/                    # Your websites
    â”œâ”€â”€ ğŸ“‹ _template/            # Site template
    â”‚   â”œâ”€â”€ ğŸ“„ index.html
    â”‚   â”œâ”€â”€ ğŸ˜ index.php
    â”‚   â”œâ”€â”€ ğŸ˜ info.php
    â”‚   â”œâ”€â”€ ğŸ¨ main.js
    â”‚   â””â”€â”€ ğŸ’„ styles.css
    â””â”€â”€ ğŸŒ example.com/          # Example site
        â”œâ”€â”€ ğŸ“„ index.html
        â”œâ”€â”€ ğŸ˜ index.php
        â”œâ”€â”€ ğŸ˜ info.php
        â”œâ”€â”€ ğŸ¨ main.js
        â””â”€â”€ ğŸ’„ styles.css
```
## âš™ï¸ How It Works

| ğŸ”„ **Process** | ğŸ¯ **What Happens** | ğŸ›¡ï¸ **Security** |
|----------------|---------------------|-----------------|
| ğŸŒ **Request Arrives** | Caddy receives request for `example.com` | Validates hostname |
| ğŸ“ **File Serving** | Serves content from `sites/example.com/` | Read-only access |
| ğŸ”’ **Certificate Check** | Checks if SSL cert exists | Automatic renewal |
| âœ… **Approval Process** | Asks `ask` service for domain approval | Directory must exist |
| ğŸ‰ **Response** | Serves content with HTTPS | Security headers applied |
### ğŸ”§ **Key Components**

| ğŸ³ **Service** | ğŸ¯ **Purpose** | ğŸ”’ **Security Level** |
|----------------|----------------|----------------------|
| ğŸŒ **Caddy** | Web server & HTTPS | High - Security headers, CSP |
| âœ… **Ask Service** | Domain approval | Medium - Internal only |
| ğŸ˜ **PHP-FPM** | PHP processing | High - Read-only mounts |
| ğŸ“Š **Node Exporter** | System metrics | High - Internal network |
| ğŸ“ˆ **PHP-FPM Exporter** | PHP metrics | High - Internal network |
## ğŸ›¡ï¸ Security

| ğŸ›¡ï¸ **Security Layer** | âœ… **Status** | ğŸ¯ **Protection** |
|----------------------|---------------|------------------|
| ğŸ”’ **HTTPS/TLS** | âœ… Active | Automatic Let's Encrypt |
| ğŸ›¡ï¸ **Security Headers** | âœ… Active | HSTS, CSP, X-Frame-Options |
| ğŸš« **Information Disclosure** | âœ… Blocked | PHP info disabled, paths hidden |
| ğŸ” **Basic Authentication** | âš ï¸ Limited | Simple auth for monitoring |
| ğŸŒ **Network Isolation** | âœ… Active | Internal networks only |
| ğŸ“ **Read-only Mounts** | âœ… Active | File system protection |
| ğŸ“Š **Health Monitoring** | âœ… Active | Service health checks |
> âš ï¸ **Security Note**: This setup provides **production-ready security** suitable for small to medium projects. For enterprise environments, additional hardening (secrets management, advanced authentication, SIEM integration) would be required.

### ğŸ”‘ **Security Configuration**

| ğŸ”§ **Component** | ğŸ” **Authentication** | ğŸ“ **Access** |
|------------------|----------------------|---------------|
| **Caddy Metrics** (2019) | Basic Auth | `metrics_user:monitoring_password_2024` |
| **Ask Service** (8080) | Bearer Token | SHA256(`METRICS_SECRET`) |
**Required `.env` configuration:**
```bash
# ğŸ“§ Caddy email for SSL certificates (REQUIRED)
CADDY_EMAIL=your-email@example.com

# ğŸ” Metrics authentication secret (AUTO-GENERATED)
METRICS_SECRET=change-this-secret-key-here  # Will be auto-generated by start.sh
```

> ğŸ“– **For complete security documentation, see [SECURITY.md](SECURITY.md)**

## ğŸ¨ Per-Site Customization

| ğŸ¯ **Customization** | ğŸ’¡ **Use Case** | ğŸ”§ **Implementation** |
|---------------------|-----------------|----------------------|
| ğŸ“ **Static Files** | Most sites | Drop files into domain folder |
| ğŸ”„ **Redirects** | Special routing | Add per-host `handle` blocks |
| ğŸ›¡ï¸ **Custom Headers** | Security policies | Extend Caddyfile configuration |
| ğŸ¨ **Custom CSS/JS** | Styling & functionality | Add to site's folder |
---

## ğŸ§ª Staging Certificates (Optional)
**For testing without Let's Encrypt rate limits:**
```caddy
# Add to :443 block in Caddyfile
tls {
  issuer acme {
    ca https://acme-staging-v02.api.letsencrypt.org/directory
  }
}
```
**Apply changes:**
```bash
docker compose restart caddy
```

## ğŸ’¾ Backups

```bash
./scripts/backup.sh
```
### ğŸ“¦ **What Gets Backed Up**

| ğŸ“ **Component** | ğŸ¯ **Purpose** | ğŸ“ **Location** |
|------------------|----------------|-----------------|
| ğŸŒ **All Sites** | Website content | `sites/` directory |
| âš™ï¸ **Configuration** | Caddy & Docker configs | `Caddyfile`, `compose.yml` |
| ğŸ”’ **SSL Certificates** | Let's Encrypt certs | Caddy Docker volumes |
| ğŸ³ **Docker Volumes** | Persistent data | Caddy state & config |
**Backup storage:** `./backups/` with timestamps  
**Format:** Compressed `.tar.gz` archives

> âš ï¸ **Note**: This is a manual backup system. For production, consider automated backups with cron jobs or external solutions.

## âœ… Validation

```bash
./scripts/validate.sh
```
### ğŸ• **When to Run Validation**

| â° **Timing** | ğŸ¯ **Purpose** | âœ… **Checks** |
|---------------|----------------|---------------|
| ğŸš€ **Before startup** | Pre-flight checks | Environment, Docker, configs |
| âœï¸ **After edits** | Post-change validation | `.env`, `Caddyfile` changes |
| ğŸ”§ **Configuration** | Setup verification | All settings valid |
| ğŸ› **Troubleshooting** | Issue diagnosis | System health |
| ğŸ“… **Regular checks** | Maintenance | Ongoing validation |
### ğŸ” **What Gets Validated**

| âœ… **Check** | ğŸ¯ **Purpose** | ğŸ“ **Location** |
|--------------|----------------|-----------------|
| ğŸ“„ **Environment** | `.env` file exists & required variables set | Configuration |
| ğŸ” **CADDY_EMAIL** | SSL certificate email configured | Let's Encrypt |
| ğŸ”‘ **METRICS_SECRET** | Monitoring authentication secret set | Security |
| âš™ï¸ **Caddyfile** | Syntax and formatting valid | Web server config |
| ğŸ³ **Docker** | Docker daemon running | Container platform |
| ğŸ”§ **Configuration** | All settings valid | Complete setup |
## âš¡ Performance Optimization
### ğŸŒ **UDP Buffer Sizes (HTTP/3)**

| âš ï¸ **Issue** | ğŸ”§ **Solution** | ğŸ¯ **Benefit** |
|--------------|-----------------|----------------|
| UDP buffer warnings | `sudo ./scripts/fix-udp-buffers.sh` | Better HTTP/3 performance |
**What the script does:**
- âœ… Sets optimal UDP buffer sizes for HTTP/3 (QUIC)
- âœ… Makes changes persistent across reboots  
- âœ… Improves performance for high-traffic sites

> ğŸ’¡ **Note**: UDP warnings don't break functionality, but fixing them improves performance.

## ğŸ“Š Monitoring

```bash
sudo ./scripts/setup-monitoring-simple.sh
```
### ğŸ“ˆ **What You Get**

| ğŸ“Š **Metric Type** | ğŸ¯ **What's Monitored** | ğŸ”§ **Tool** |
|-------------------|-------------------------|-------------|
| ğŸ–¥ï¸ **System** | RAM, CPU, disk usage | Node Exporter |
| ğŸŒ **Web Traffic** | Request rates, response times, errors | Caddy Metrics |
| ğŸ˜ **PHP Performance** | Process pool status | PHP-FPM Exporter |
| âœ… **Application** | Domain approvals, service health | Ask Service |
### ğŸ”§ **Setup Features**

- âœ… **Automatic security configuration**
- âœ… **Prometheus targets provided**
- âœ… **Grafana integration ready**
- âœ… **Internal network isolation**

**Quick status check:**
```bash
./scripts/status.sh
```

> ğŸ“– **For detailed monitoring setup, see [monitoring/README.md](monitoring/README.md)**

## ğŸ”§ Troubleshooting
### ğŸš¨ **Common Issues**

| âŒ **Problem** | âœ… **Solution** | ğŸ”§ **Command** |
|----------------|-----------------|----------------|
| ğŸŒ **Ports not open** | Open 80 & 443 | Firewall configuration |
| ğŸ” **DNS not resolving** | Check DNS records | `dig your-domain.com` |
| âš ï¸ **UDP warnings** | Fix buffer sizes | `sudo ./scripts/fix-udp-buffers.sh` |
| ğŸ”’ **Certificate issues** | Check domain setup | See certificate section below |
### ğŸ” **Diagnostic Steps**
1. **Run validation first:**
   ```bash
   ./scripts/validate.sh
   ```

2. **Check service logs:**
   ```bash
   docker compose logs -f caddy | cat
   ```

3. **Verify service status:**
   ```bash
   ./scripts/status.sh
   ```

### ğŸ”’ **Certificate Troubleshooting**

| âœ… **Check** | ğŸ¯ **Action** | ğŸ“ **Location** |
|--------------|---------------|-----------------|
| ğŸ“ **Site exists** | Ensure `sites/<domain>/` exists | `sites/example.com/index.html` |
| ğŸŒ **HTTP first** | Trigger redirect | `curl -I http://<domain>` |
| ğŸ”’ **HTTPS test** | Test certificate | `curl -I https://<domain>` |
| ğŸ“ **Check logs** | Review service logs | `docker compose logs -f caddy ask` |
### â˜ï¸ **Cloudflare Users**

- Set SSL/TLS mode to **Full** or **Full strict**
- Consider **DNS-only** (grey cloud) while debugging
- Ensure DNS records point to your server IP

---
## ğŸ‰ **You're All Set!**
**Your multi-site hosting solution is ready with enterprise-grade security and monitoring.**

### ğŸ“š **Documentation Links**

- ğŸ›¡ï¸ **[Security Guide](SECURITY.md)** - Complete security documentation
- ğŸ“Š **[Monitoring Setup](monitoring/README.md)** - Metrics and monitoring
- ğŸ”§ **[Troubleshooting](#-troubleshooting)** - Common issues and solutions

### ğŸš€ **Quick Commands**

```bash
./scripts/start.sh          # Start everything
./scripts/add-site.sh domain.com  # Add new site
./scripts/status.sh         # Check status
./scripts/backup.sh         # Create backup
./scripts/generate-secret.sh # Generate secure METRICS_SECRET
./scripts/validate.sh       # Validate configuration
./scripts/format-caddyfile.sh # Format Caddyfile
./scripts/cf-set-dns.sh domain.com # Set Cloudflare DNS
```

---

**ğŸ›¡ï¸ Security Level: PRODUCTION-READY** â€¢ **ğŸ“Š Monitoring: ACTIVE** â€¢ **ğŸ”’ HTTPS: AUTOMATIC**
